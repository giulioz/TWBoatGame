swagger: "2.0"
info:
  version: 1.0.0
  title: SeaDuelServer
  description: SeaDuelServer
basePath: /api/v1
securityDefinitions:
  Bearer:
    type: apiKey
    name: Authorization
    in: header
    description: |
      For accessing the API a valid JWT token must be passed in all the queries in
      the 'Authorization' header.

      A valid JWT token is generated by the API and retourned as answer of a call
      to the route /login giving a valid user & password.

      The following syntax must be used in the 'Authorization' header :
          Bearer xxxxxx.yyyyyyy.zzzzzz
tags:
  - name: Authentication
  - name: Users
  - name: Messaging
  - name: Games

consumes:
  - application/json
produces:
  - application/json

definitions:
  Login:
    type: object
    title: Login
    required:
      - id
      - password
    properties:
      id:
        type: string
        description: "Username"
      password:
        type: string
        format: "password"
  User:
    type: object
    title: User
    properties:
      id:
        type: string
        description: "Username"
      email:
        type: string
        format: "email"
      password:
        type: string
        format: "password"
      role:
        type: string
        enum:
          - user
          - administrator
      registrationDate:
        type: string
        format: "date-time"
      state:
        type: string
        enum:
          - offline
          - online
      wonGames:
        type: number
        description: "Won or opponent resigned"
      lostGames:
        type: number
        description: "Lost or withdrawn"
      position:
        type: number
        description: "Position in ranking, calculated with won and lost games ratio"
      lastActivity:
        type: string
        format: "date-time"
        description: "Last http request made by user, for online check"
      playing:
        type: boolean
        description: "True if the user is playing a game with someone"
      hasUnreadMessages:
        type: boolean
        description: "True if there are messages coming from that user"
      hasUnreadGames:
        type: boolean
        description: "True if there are games coming from that user"

  Game:
    type: object
    title: Game
    required:
      - playerId
      - opponentId
      - winnerId
      - playerBoard
      - opponentBoard
      - playerReady
      - opponentReady
      - startTime
      - availableBoats
    properties:
      playerId:
        type: string
        description: "Your user id"
      opponentId:
        type: string
        description: "The opponent user id"
      state:
        type: string
        enum:
          - WaitingForResponse
          - HasToRespond
          - BoatsPositioning
          - PlayerTurn
          - OpponentTurn
          - Ended
      winnerId:
        type: string
        description: "UserId of the winner, null if still playing or game never started"
      playerBoard:
        type: object
        title: PlayerBoard
        required:
          - width
          - height
          - boardData
        properties:
          width:
            type: number
            description: "10 by default"
          height:
            type: number
            description: "10 by default"
          boardData:
            type: array
            items:
              type: object
              required:
                - type
                - checked
              properties:
                type:
                  type: string
                  enum:
                    - Empty
                    - Destroyer
                    - Submarine
                    - Battleship
                    - AircraftCarrier
                checked:
                  type: boolean
                  description: "True if that cell was attacked by the opponent"
      opponentBoard:
        type: object
        title: OpponentBoard
        required:
          - width
          - height
          - boardData
        properties:
          width:
            type: number
            description: "10 by default"
          height:
            type: number
            description: "10 by default"
          boardData:
            type: array
            items:
              type: object
              required:
                - type
              properties:
                type:
                  type: string
                  enum:
                    - Unknown
                    - Hit
                    - Miss
                    - Boat
      playerReady:
        type: boolean
        description: "If the player has positioned his boats"
      opponentReady:
        type: boolean
        description: "If the opponent has positioned his boats"
      startTime:
        type: string
        format: "date-time"
        description: "Time when the game first started"
      availableBoats:
        type: array
        description: "Boats available to position"
        items:
          type: object
          required:
            - type
            - amount
          properties:
            type:
              type: string
              enum:
                - Destroyer
                - Submarine
                - Battleship
                - AircraftCarrier
            amount:
              type: number
              description: "Numbers of boats of that kind available"

  Message:
    type: object
    title: Message
    required:
     - content
     - time
     - senderId
     - recipientId
    properties:
      content:
        type: string
        description: "The body of the message"
      time:
        type: string
        format: "date-time"
        description: "When the message have been received by the server"
      senderId:
        type: string
        description: "User id of the sender"
      recipientId:
        type: string
        description: "User id of the receiver"

paths:
  /auth/login:
    post:
      tags:
        - Authentication
      parameters:
        - name: body
          in: body
          required: true
          description: "Login credentials"
          schema:
            $ref: "#/definitions/Login"
      description: "Gets a new signed token from username and password"
      responses:
        200:
          description: "Logged in"
          schema:
            type: string
            description: "The token"
        403:
          description: "Invalid credentials"
    get:
      tags:
        - Authentication
      security:
        - Bearer: []
      description: "Checks a token validity"
      responses:
        200:
          description: "Token is valid"
        403:
          description: "Invalid credentials"

  /users:
    get:
      tags:
        - Users
      security:
        - Bearer: []
      description: "Get the list of all the registered users, requires admin privileges"
      responses:
        200:
          description: "Return all the users"
          schema:
            type: array
            items:
              $ref: "#/definitions/User"
        403:
          description: "Access Denied"
    post:
      tags:
        - Users
      parameters:
        - name: body
          in: body
          required: true
          description: "The user to create"
          schema:
            type: object
            title: NewUser
            required:
              - id
              - email
              - password
            properties:
              id:
                type: string
                description: "Username"
              email:
                type: string
                format: "email"
              password:
                type: string
                format: "password"
      description: "Create a new user"
      responses:
        201:
          description: "User created successfully"
        400:
          description: "Invalid user format or request"
        409:
          description: "User already exists"
        429:
          description: "Too many user creation requests"

  /users/findId/{id}:
    get:
      tags:
        - Users
      security:
        - Bearer: []
      parameters:
        - name: id
          in: path
          required: true
          description: "The first characters of the user id to find"
          type: string
      description: "Find user by user id"
      responses:
        200:
          description: "Return all the matching users"
          schema:
            type: array
            items:
              $ref: "#/definitions/User"
        403:
          description: "Access Denied"

  /users/byId/{id}:
    get:
      tags:
        - Users
      security:
        - Bearer: []
      parameters:
        - name: id
          in: path
          required: true
          description: "The id of the user to retrieve"
          type: string
      description: "Get info about an user"
      responses:
        200:
          description: "Return the user with the specified id"
          schema:
            $ref: "#/definitions/User"
        404:
          description: "User id not found"
        403:
          description: "Access Denied"
    delete:
      tags:
        - Users
      security:
        - Bearer: []
      parameters:
        - name: id
          in: path
          required: true
          description: "The id of the user to delete"
          type: string
      description: "Delete an user, requires admin privileges"
      responses:
        200:
          description: "User deleted"
        404:
          description: "User id not found"
        403:
          description: "Access Denied"
    put:
      tags:
        - Users
      security:
        - Bearer: []
      parameters:
        - name: id
          in: path
          required: true
          description: "The id of the user to update"
          type: string
        - name: body
          in: body
          required: true
          description: "The fields to update, leave password empty to not edit"
          schema:
            $ref: "#/definitions/User"
      description: "Update user info, requires admin privileges or to be the same user"
      responses:
        200:
          description: "User updated successfully"
        400:
          description: "Invalid user format or request"
        404:
          description: "User id not found"

  /users/contacts:
    get:
      tags:
        - Users
      security:
        - Bearer: []
      description: "Get the users in contact with the logged in user"
      responses:
        200:
          description: "Return the users"
          schema:
            type: array
            items:
              $ref: "#/definitions/User"
        403:
          description: "Access Denied"

  /users/waiting:
    get:
      tags:
        - Users
      security:
        - Bearer: []
      description: "Get random users waiting to play"
      responses:
        200:
          description: "Return the users"
          schema:
            type: array
            items:
              $ref: "#/definitions/User"
        403:
          description: "Access Denied"

  /users/top:
    get:
      tags:
        - Users
      security:
        - Bearer: []
      description: "Get the ranking top 10 users"
      responses:
        200:
          description: "Return the users"
          schema:
            type: array
            items:
              $ref: "#/definitions/User"
        403:
          description: "Access Denied"

  /users/byId/{id}/messages:
    get:
      tags:
        - Messaging
      security:
        - Bearer: []
      parameters:
        - name: id
          in: path
          required: true
          description: "The user id of the sender"
          type: string
      description: "Get the messages coming from an user"
      responses:
        200:
          description: "Return the messages"
          schema:
            type: array
            items:
              $ref: "#/definitions/Message"
        404:
          description: "User id not found"
        403:
          description: "Access Denied"
    post:
      tags:
        - Messaging
      security:
        - Bearer: []
      parameters:
        - name: id
          in: path
          required: true
          description: "The user id of the recipient"
          type: string
        - name: body
          in: body
          required: true
          description: "The body of the message to send"
          schema:
            type: object
            title: MessageObject
            required:
              - content
            properties:
              content:
                type: string
      description: "Sends a message to an user"
      responses:
        200:
          description: "Message sent successfully, returns the message"
          schema:
            $ref: "#/definitions/Message"
        404:
          description: "Invalid user id"

  /users/byId/{id}/game:
    get:
      tags:
        - Games
      security:
        - Bearer: []
      parameters:
        - name: id
          in: path
          required: true
          description: "The user id of the opponent"
          type: string
      description: "Get the game status with the specified opponent"
      responses:
        200:
          description: "Return the game"
          schema:
            $ref: "#/definitions/Game"
        404:
          description: "User id not found"
        403:
          description: "Access Denied"
    post:
      tags:
        - Games
      security:
        - Bearer: []
      parameters:
        - name: id
          in: path
          required: true
          description: "The user id of the opponent"
          type: string
      description: "Send a new game request to an user"
      responses:
        200:
          description: "Game request sent successfully"
        409:
          description: "Game already started"
        404:
          description: "User id not found"
        403:
          description: "Access Denied"
    put:
      tags:
        - Games
      security:
        - Bearer: []
      parameters:
        - name: id
          in: path
          required: true
          description: "The user id of the opponent"
          type: string
      description: "Accept a game request from an user"
      responses:
        200:
          description: "Game accepted successfully"
        404:
          description: "Game not found"
        403:
          description: "Access Denied"
    delete:
      tags:
        - Games
      security:
        - Bearer: []
      parameters:
        - name: id
          in: path
          required: true
          description: "The user id of the opponent"
          type: string
      description: "Resign from a game, that game will be counted as lost for the user and won for the opponent"
      responses:
        200:
          description: "Resigned succesfully"
        404:
          description: "User id not found"
        403:
          description: "Access Denied"

  /users/byId/{id}/game/boats:
    post:
      tags:
        - Games
      security:
        - Bearer: []
      parameters:
        - name: id
          in: path
          required: true
          description: "The user id of the opponent"
          type: string
        - name: body
          in: body
          required: true
          description: "The boat to add"
          schema:
            type: object
            title: Boat
            required:
              - x
              - y
              - direction
              - type
            properties:
              x:
                type: number
                description: "X position of the boat"
              y:
                type: number
                description: "Y position of the boat"
              direction:
                type: string
                description: "Direction of the boat, it will be placed towards positive axis value (right or down)"
                enum:
                  - Vertical
                  - Horizontal
              type:
                type: string
                description: "See documentation for boat sizes"
                enum:
                  - Destroyer
                  - Submarine
                  - Battleship
                  - AircraftCarrier
      description: "Adds a new boat during initial positioning"
      responses:
        200:
          description: "Boat added successfully"
        400:
          description: "Invalid position or boat type"
        404:
          description: "User id not found"
        403:
          description: "Access Denied"

  /users/byId/{id}/game/moves:
    post:
      tags:
        - Games
      security:
        - Bearer: []
      parameters:
        - name: id
          in: path
          required: true
          description: "The user id of the opponent"
          type: string
        - name: body
          in: body
          required: true
          schema:
            type: object
            title: Move
            required:
              - x
              - y
            properties:
              x:
                type: number
                description: "X position to fire"
              y:
                type: number
                description: "Y position to fire"
      description: "Fires a shot into the opponent board"
      responses:
        200:
          description: "Move done successfully"
        400:
          description: "Invalid move"
        404:
          description: "User id not found"
        403:
          description: "Access Denied"
